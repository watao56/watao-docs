# エージェントモード活用ガイド

Claude Code のエージェント機能を最大限活用するためのガイド。サブエージェント、Agent Teams（マルチエージェント）、並列開発の実践的な使い方を解説する。

## サブエージェント

### サブエージェントとは

独自のコンテキストウィンドウとツールセットで動作する**専門化されたエージェント**。メインの会話を汚さずに特定タスクを実行できる。

> コンテキストが根本的な制約であるため、**サブエージェントは最も強力なツールの1つ**。Claude がコードベースを調査すると大量のファイルを読み込み、コンテキストを消費する。サブエージェントは別のコンテキストウィンドウで動作し、要約だけを報告する。
>
> — [公式ベストプラクティス](https://code.claude.com/docs/en/best-practices)

### ビルトインサブエージェント

Claude Code には以下のビルトインサブエージェントが含まれる：

| エージェント | モデル | 用途 |
|------------|--------|------|
| **Explore** | Haiku（高速） | 読み取り専用。ファイル検索、コード探索 |
| **Plan** | 親から継承 | Plan Mode でのコードベース調査 |
| **汎用** | 親から継承 | 複雑な調査、マルチステップ操作、コード修正 |
| **Bash** | 親から継承 | 別コンテキストでのターミナルコマンド実行 |
| **Claude Code Guide** | Haiku | Claude Code 自体の機能についての質問 |

### 実践的な使い方

#### 調査にサブエージェントを使う

```
サブエージェントを使って、認証システムがトークンリフレッシュを
どう処理しているか、既存の OAuth ユーティリティがあるか調査して。
```

サブエージェントがコードベースを探索し、関連ファイルを読み、結果を要約して報告する。メインの会話のコンテキストは汚れない。

#### 実装後の検証にサブエージェントを使う

```
サブエージェントを使ってこのコードのエッジケースをレビューして。
```

### カスタムサブエージェントの作成

`.claude/agents/` にマークダウンファイルを配置する：

```yaml
# .claude/agents/security-reviewer.md
---
name: security-reviewer
description: コードのセキュリティレビュー
tools: Read, Grep, Glob, Bash
model: opus
---
シニアセキュリティエンジニアとしてコードをレビューする:

- インジェクション脆弱性（SQL, XSS, コマンド）
- 認証・認可の欠陥
- コード内のシークレットや認証情報
- 安全でないデータ処理

具体的な行番号と修正案を提示する。
```

使い方: 「セキュリティレビューのサブエージェントを使ってこのコードをレビューして」

### サブエージェントの配置場所

| 場所 | スコープ | 優先度 |
|------|---------|--------|
| `--agents` CLI フラグ | 現在のセッションのみ | 1（最高） |
| `.claude/agents/` | プロジェクト | 2 |
| `~/.claude/agents/` | 全プロジェクト | 3 |
| プラグインの `agents/` | プラグイン有効時 | 4（最低） |

### フロントマター設定

| フィールド | 必須 | 説明 |
|-----------|------|------|
| `name` | はい | 一意の識別子（小文字・ハイフン） |
| `description` | はい | いつ使うかの説明 |
| `tools` | いいえ | 使用可能なツール（省略時は全ツール継承） |
| `disallowedTools` | いいえ | 拒否するツール |
| `model` | いいえ | `sonnet`, `opus`, `haiku`, `inherit` |
| `permissionMode` | いいえ | `default`, `acceptEdits`, `plan`, `bypassPermissions` 等 |
| `maxTurns` | いいえ | 最大ターン数 |
| `skills` | いいえ | プリロードするスキル |
| `memory` | いいえ | `user`, `project`, `local`（永続メモリ） |
| `hooks` | いいえ | サブエージェント固有のフック |
| `mcpServers` | いいえ | 利用可能な MCP サーバー |

### 永続メモリ

サブエージェントに `memory` フィールドを設定すると、セッションをまたいで知識を蓄積できる：

```yaml
---
name: code-reviewer
description: コード品質とベストプラクティスのレビュー
memory: user
---
コードレビューアーとして活動する。レビュー中に発見したパターン、
規約、繰り返し発生する問題をエージェントメモリに更新すること。
```

| スコープ | 保存先 | 使い方 |
|---------|--------|--------|
| `user` | `~/.claude/agent-memory/<name>/` | 全プロジェクトで学習を記憶（推奨デフォルト） |
| `project` | `.claude/agent-memory/<name>/` | プロジェクト固有の知識（バージョン管理可） |
| `local` | `.claude/agent-memory-local/<name>/` | プロジェクト固有だがバージョン管理しない |

!!! tip "メモリの活用"
    - 作業前に「メモリを確認して、以前見つけたパターンがあるか確認して」
    - 作業後に「今学んだことをメモリに保存して」
    - 時間とともにサブエージェントはより効果的になる

### CLI フラグでの一時的なサブエージェント

```bash
claude --agents '{
  "code-reviewer": {
    "description": "コード変更後に自動的にレビュー",
    "prompt": "シニアコードレビューアーとして。品質、セキュリティ、ベストプラクティスに注目。",
    "tools": ["Read", "Grep", "Glob", "Bash"],
    "model": "sonnet"
  }
}'
```

## Agent Teams（マルチエージェント）

### Agent Teams とは

複数の Claude Code インスタンスが協調して動作する仕組み。1つのセッションがチームリーダーとして作業を調整し、チームメイトがそれぞれ独立したコンテキストウィンドウで作業する。

サブエージェントとの違い：

| | サブエージェント | Agent Teams |
|---|--------------|-------------|
| **コンテキスト** | 独自。結果を呼び出し元に返す | 独自。完全に独立 |
| **コミュニケーション** | メインエージェントへの報告のみ | チームメイト間で直接メッセージ |
| **コーディネーション** | メインが全作業を管理 | 共有タスクリストで自己調整 |
| **最適な用途** | 結果だけが必要な集中タスク | 議論・協力が必要な複雑な作業 |
| **トークンコスト** | 低い | 高い（各チームメイトが個別のインスタンス） |

### Agent Teams を有効化する

```json
// settings.json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  }
}
```

### 実践的なユースケース

#### 並列コードレビュー

```
PR #142 をレビューする Agent Team を作成して。3人のレビューアーを起動：
- 1人はセキュリティの影響に集中
- 1人はパフォーマンスへの影響をチェック
- 1人はテストカバレッジを検証
各自レビューして結果を報告して。
```

#### 競合仮説での調査

```
ユーザーがアプリが1メッセージ後に終了すると報告している。
5人のエージェントチームメイトを起動して異なる仮説を調査して。
互いの仮説を反証しようとする科学的議論のように会話させて。
合意が得られた結果をドキュメントに記録して。
```

#### Writer/Reviewer パターン

| セッション A（Writer） | セッション B（Reviewer） |
|----------------------|------------------------|
| API エンドポイントのレート制限を実装 | — |
| — | `@src/middleware/rateLimiter.ts` のレート制限実装をレビュー。エッジケース、競合状態、既存ミドルウェアとの一貫性を確認 |
| レビューのフィードバックに対応: [セッション B の出力] | — |

### Agent Teams のベストプラクティス

**チームメイトに十分なコンテキストを与える**：チームメイトはリーダーの会話履歴を継承しない。スポーン時にタスク固有の詳細を含める。

```
セキュリティレビューのチームメイトを起動。プロンプト：「src/auth/ の
認証モジュールをセキュリティ脆弱性についてレビューして。トークン処理、
セッション管理、入力バリデーションに注目。アプリは httpOnly Cookie に
保存した JWT トークンを使用。問題があれば重大度評価付きで報告。」
```

**タスクの適切なサイズ**：

- 小さすぎ → 調整オーバーヘッドが利益を超える
- 大きすぎ → チェックインなしで長時間作業し、無駄なリスク増大
- ちょうど良い → 明確な成果物を生む自己完結型の単位（関数、テストファイル、レビュー）

**ファイルの衝突を避ける**: 2人のチームメイトが同じファイルを編集すると上書きが発生する。各チームメイトが異なるファイルセットを担当するよう分割する。

**リサーチ・レビューから始める**: Agent Teams が初めてなら、コードを書かないタスク（PR レビュー、ライブラリ調査、バグ調査）から始める。

### 表示モード

| モード | 説明 | 要件 |
|--------|------|------|
| **In-process** | 全チームメイトがメインターミナルで動作。`Shift+↑/↓` で選択 | なし |
| **Split panes** | 各チームメイトが独自のペイン | tmux または iTerm2 |

```json
// settings.json で設定
{
  "teammateMode": "in-process"
}
```

## 並列開発のパターン

### Git Worktree を使った並列セッション

```bash
# worktree を作成
git worktree add ../myapp-auth feature/auth
git worktree add ../myapp-tests feature/tests
git worktree add ../myapp-docs feature/docs

# 各ターミナル/タブで独立した Claude Code セッションを起動
# タブ1: 認証機能開発
cd ~/projects/myapp-auth && claude

# タブ2: テスト作成
cd ~/projects/myapp-tests && claude

# タブ3: ドキュメント作成
cd ~/projects/myapp-docs && claude
```

各セッションは独立したコンテキストで動作するため、互いに干渉しない。

### ヘッドレスモードでのファンアウト

大規模なマイグレーションや分析で、多数の並列 Claude を分散実行：

```bash
#!/bin/bash
# 複数ファイルを並列で処理
find src -name "*.ts" | while read file; do
  claude -p "このファイルを ESM に移行して: $file" \
    --allowedTools "Read,Edit,Bash" &
done
wait
echo "全ファイルの移行完了"
```

### セッションの命名と再開

```bash
# セッションに名前を付ける（Claude Code 内で）
/rename oauth-migration

# 最近の会話を続ける
claude --continue

# セッションピッカーで選択
claude --resume

# PR に紐付けたセッションを再開
claude --from-pr 123
```

セッションはブランチのように使う。異なるワークストリームには別々の永続的コンテキストを持たせる。

## Plan Mode の活用

### Plan Mode とは

Claude に読み取り専用の操作でコードベースを分析させ、計画を作成させるモード。コードを変更せずに探索・計画・レビューが可能。

### いつ使うか

- **マルチステップ実装**: 多くのファイルを編集する機能の場合
- **コード探索**: 変更前にコードベースを徹底的に調査したい場合
- **インタラクティブ開発**: Claude と方向性を反復したい場合

### 使い方

```bash
# セッション中に切り替え（Shift+Tab を2回）
# Normal Mode → Auto-Accept → Plan Mode

# Plan Mode で新規セッション起動
claude --permission-mode plan

# ヘッドレスモードで Plan Mode
claude --permission-mode plan -p "認証システムを分析して改善提案を出して"
```

### デフォルトに設定

```json
// .claude/settings.json
{
  "permissions": {
    "defaultMode": "plan"
  }
}
```

## Claude にインタビューさせる

大きな機能を実装する前に、Claude に要件をヒアリングさせる：

```
[機能の簡単な説明]を構築したい。AskUserQuestion ツールを使って
詳細にインタビューして。

技術的な実装、UI/UX、エッジケース、懸念事項、トレードオフに
ついて質問して。自明な質問は避け、見落としそうな難しい部分を掘り下げて。

全てカバーするまでインタビューを続けて、完了したら SPEC.md に
完全な仕様書を書いて。
```

仕様書が完成したら、**新しいセッション**で実装を開始する。新セッションはクリーンなコンテキストで実装に集中でき、書かれた仕様を参照できる。

# Tips & Tricks

コスト最適化、プロンプト設計、権限設定、Extended Thinking、よくある失敗パターンとその対策。

## コスト最適化

### コンテキスト管理が全て

Claude Code のコストはトークン消費量に直結する。コンテキストウィンドウが埋まるほど、トークン消費も品質低下も加速する。

> Claude のコンテキストウィンドウには会話全体が入る：全メッセージ、Claude が読んだ全ファイル、全コマンド出力。しかしこれはすぐに埋まる。1回のデバッグやコードベース探索で数万トークンを生成・消費することがある。
>
> — [公式ベストプラクティス](https://code.claude.com/docs/en/best-practices)

#### 基本戦略

1. **`/clear`** — タスク完了ごとにコンテキストをリセット
2. **`/compact`** — 長い会話を要約して圧縮（`/compact API変更に集中` でフォーカス指定可能）
3. **1セッション1タスク** — 複数の無関係なタスクを1セッションに詰め込まない
4. **サブエージェント** — 調査は別コンテキストで実行、結果の要約だけ受け取る
5. **`/rewind` + 要約** — `Esc × 2` で選択メッセージから要約し、前のコンテキストは保持

#### .claudeignore で不要ファイルを除外

```bash
# .claudeignore
node_modules/
dist/
build/
.git/
*.min.js
*.map
coverage/
__pycache__/
.next/
```

#### カスタムコンパクション指示

CLAUDE.md にコンパクション時の指示を書ける：

```markdown
# コンパクション時の注意
コンパクション実行時は、変更したファイルの完全なリストとテストコマンドを必ず保持すること。
```

### モデルの使い分け

| シナリオ | 推奨モデル |
|----------|-----------|
| 複雑なアーキテクチャ設計、難しい推論 | Opus |
| 日常的な実装・デバッグ | Sonnet |
| 高速な探索・簡単な質問 | Haiku |

```bash
# モデル切り替え（Claude Code 内）
/model opus
/model sonnet
/model haiku
```

### Agent Teams のトークンコスト

Agent Teams は各チームメイトが個別のコンテキストウィンドウを持つため、トークン使用量が大幅に増える。リサーチ・レビュー・新機能開発では追加トークンに見合う価値があるが、ルーチンタスクでは単一セッションの方がコスト効率が良い。

## プロンプトエンジニアリング

### 効果的なプロンプトの型

#### 具体的な指示 + 検証条件

```
validateEmail 関数を書いて。
テストケース:
- user@example.com → true
- invalid → false
- user@.com → false
実装後にテストを実行して確認して。
```

#### 既存パターンの参照

```
既存のウィジェット実装を確認して（HotDogWidget.php が良い例）。
同じパターンに従ってカレンダーウィジェットを実装して。
月選択とページネーション機能付き。
外部ライブラリは、既にコードベースで使われているもの以外使わない。
```

#### 症状の具体的な記述

```
セッションタイムアウト後にログインが失敗する。
src/auth/ の認証フロー、特にトークンリフレッシュを確認して。
問題を再現するテストを書いてから修正して。
```

#### スクリーンショットベースの UI 指示

```
[画像をペースト]
このデザインを実装して。完成後にスクリーンショットを撮って
元のデザインと比較して。差異があれば修正して。
```

#### Claude にインタビューさせる

```
[機能の簡単な説明]を構築したい。AskUserQuestion ツールを使って
詳細にインタビューして。
自明な質問は避け、見落としそうな部分を掘り下げて。
全てカバーしたら SPEC.md に完全な仕様書を書いて。
```

### やってはいけないこと

| ❌ 悪い例 | ✅ 良い例 | 理由 |
|----------|----------|------|
| 「このファイルを改善して」 | 「この関数のエラーハンドリングを追加。null ケースを処理」 | スコープが曖昧 |
| 「バグを直して」 | 「ログイン後のリダイレクト失敗。src/auth/redirect.ts を確認」 | 症状と場所が不明 |
| 「テストを書いて」 | 「src/utils/parser.ts のエッジケーステスト。空文字列、null、巨大入力」 | 対象とケースが不明 |
| 「調査して」（スコープなし） | 「src/auth/ のトークンリフレッシュ処理を調査して」 | 無限探索になる |

!!! tip "曖昧なプロンプトが有効な場面"
    探索的な作業で軌道修正できる場合、「このファイルで何を改善する？」のような曖昧なプロンプトが有効な場合もある。思いつかなかった問題を見つけてくれることがある。

## コードベースの質問

新しいプロジェクトにオンボーディングする際、Claude Code に他のエンジニアに聞くのと同じような質問ができる：

```
「ロギングの仕組みは？」
「新しい API エンドポイントの作り方は？」
「foo.rs の 134 行目の async move { ... } は何をしている？」
「CustomerOnboardingFlowImpl はどんなエッジケースを処理している？」
「333 行目で bar() ではなく foo() を呼んでいるのはなぜ？」
```

特別なプロンプト技法は不要。直接質問するだけでよい。

## Extended Thinking（拡張思考）

### 概要

Extended Thinking はデフォルトで有効。複雑な問題で Claude が段階的に推論する空間を与える。

Opus 4.6 では**適応推論（Adaptive Reasoning）**が導入され、固定の思考トークン予算ではなく、Effort Level に基づいて動的に思考を割り当てる。

### 設定方法

| 設定 | 方法 | 詳細 |
|------|------|------|
| Effort Level | `/model` で調整 or `CLAUDE_CODE_EFFORT_LEVEL` 環境変数 | `low`, `medium`, `high`（デフォルト） |
| トグルショートカット | `Option+T`（macOS）/ `Alt+T`（Win/Linux） | 現セッションで on/off |
| グローバルデフォルト | `/config` で設定 | `alwaysThinkingEnabled` として保存 |
| トークン制限 | `MAX_THINKING_TOKENS` 環境変数 | 思考予算を制限（Opus 4.6 では 0 以外は無視） |

### いつ有効か

- 複雑なアーキテクチャ設計
- 難しいバグ
- マルチステップの実装計画
- 異なるアプローチ間のトレードオフ評価

### 思考プロセスの確認

```bash
# Verbose モードで思考過程を表示
Ctrl+O  # トグル
```

灰色のイタリック体で内部推論が表示される。

## 権限設定の最適化

### 許可リストでプロンプト疲れを防ぐ

```json
// .claude/settings.json
{
  "permissions": {
    "allow": [
      "Bash(npm run lint)",
      "Bash(npm run test*)",
      "Bash(git commit*)",
      "Bash(git push*)",
      "Read",
      "Glob",
      "Grep"
    ]
  }
}
```

!!! warning "パーミッションルールの構文"
    `Bash(git diff *)` のように末尾に `*` を付けるとプレフィックスマッチ。`*` の前のスペースが重要：`Bash(git diff*)` だと `git diff-index` にもマッチしてしまう。

### サンドボックスモード

OS レベルの分離で、ファイルシステム・ネットワークアクセスを制限しつつ Claude に自由度を与える：

```bash
claude --sandbox
```

### 全許可モード（自動化用）

```bash
# 全権限チェックをスキップ（CI/CD 等で利用）
claude --dangerously-skip-permissions
```

!!! danger "注意"
    `--dangerously-skip-permissions` は信頼できる環境でのみ使用する。ローカル開発では許可リストを推奨。

## よくある失敗パターンとその対策

Anthropic 公式ドキュメントで明記されている、避けるべき典型的なパターン：

### 1. キッチンシンク・セッション

**症状**: 1つのタスクで始め、無関係なことを聞き、元のタスクに戻る。コンテキストが無関係な情報で埋まる。

**対策**: `/clear` で無関係なタスク間にリセット。

### 2. 修正の繰り返し

**症状**: Claude が間違え、修正し、まだ間違い、また修正。コンテキストが失敗アプローチで汚染される。

**対策**: 2回修正しても直らなければ `/clear`。学んだことを反映したより良い初期プロンプトで再開。

### 3. 肥大化した CLAUDE.md

**症状**: CLAUDE.md が長すぎて、Claude が半分を無視。重要なルールがノイズに埋もれる。

**対策**: 情け容赦なく整理。Claude が指示なしで既に正しく動いていることは削除するか、確実に実行させたいなら Hook に変換。

### 4. 信頼と検証のギャップ

**症状**: Claude がもっともらしい実装を生成するが、エッジケースを処理していない。

**対策**: 常に検証手段（テスト、スクリプト、スクリーンショット）を提供する。検証できないなら出荷しない。

### 5. 無限探索

**症状**: スコープなしで「調査して」と依頼。Claude が数百のファイルを読み、コンテキストが埋まる。

**対策**: 調査のスコープを絞るか、サブエージェントを使って探索がメインコンテキストを消費しないようにする。

## マルチリポジトリ運用

### --add-dir でマルチリポジトリ

```bash
# メインリポジトリで起動し、他リポジトリも参照可能にする
claude --add-dir ../shared-lib --add-dir ../api-server
```

### モノレポでの CLAUDE.md 配置

```
monorepo/
├── CLAUDE.md                    # 共通ルール
├── .claude/
│   └── rules/
│       ├── code-style.md        # 共通コードスタイル
│       └── testing.md           # 共通テスト規約
├── packages/
│   ├── frontend/
│   │   ├── CLAUDE.md            # フロントエンド固有ルール
│   │   └── .claude/skills/      # フロントエンド固有スキル
│   ├── backend/
│   │   ├── CLAUDE.md            # バックエンド固有ルール
│   │   └── .claude/skills/
│   └── shared/
│       └── CLAUDE.md            # 共有ライブラリのルール
```

Claude Code は作業中のディレクトリに応じて、該当する階層の CLAUDE.md を自動でマージして読み込む。`.claude/rules/` のパス固有ルールを使えば、特定のファイルにのみ適用されるルールも定義できる。

## プラグインの活用

### プラグインとは

Skills、Hooks、サブエージェント、MCP サーバーを**1つのパッケージ**にまとめたもの。コミュニティや Anthropic が公開。

### コードインテリジェンスプラグイン

型付き言語を使っているなら、[コードインテリジェンスプラグイン](https://code.claude.com/docs/en/discover-plugins#code-intelligence)をインストールすると、シンボルナビゲーションや編集後の自動エラー検出が利用できる。

### コミュニティリソース

- [awesome-claude-code](https://github.com/hesreallyhim/awesome-claude-code) — プラグイン・スキル・Hook の包括的なリスト
- [awesome-claude-code-plugins](https://github.com/ccplugins/awesome-claude-code-plugins) — プラグイン集
- [awesome-claude-md](https://github.com/josix/awesome-claude-md) — CLAUDE.md の優れた実例集

## 直感を磨く

> このガイドのパターンは固定されたものではない。一般的にうまくいく出発点だが、全ての状況に最適とは限らない。
>
> — [公式ベストプラクティス](https://code.claude.com/docs/en/best-practices)

**うまくいくパターンに注意を払う。** Claude が素晴らしい出力を出した時、自分が何をしたかに気づく：プロンプトの構造、提供したコンテキスト、使ったモード。Claude が苦戦した時は、なぜかを考える。コンテキストがノイジーすぎた？プロンプトが曖昧すぎた？タスクが1回で処理するには大きすぎた？

時間とともに、ガイドでは伝えられない直感を身につけることができる。いつ具体的にするか、いつオープンエンドにするか。いつ計画してからいつ探索するか。いつコンテキストをクリアして、いつ蓄積するか。
